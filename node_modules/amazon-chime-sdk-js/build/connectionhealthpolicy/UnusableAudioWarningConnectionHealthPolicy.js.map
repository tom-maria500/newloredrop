{"version":3,"file":"UnusableAudioWarningConnectionHealthPolicy.js","sourceRoot":"","sources":["../../src/connectionhealthpolicy/UnusableAudioWarningConnectionHealthPolicy.ts"],"names":[],"mappings":";AAAA,qEAAqE;AACrE,sCAAsC;;;;;AAEtC,8FAAsE;AAKtE,MAAqB,0CACnB,SAAQ,oCAA0B;IAUlC,YAAY,aAAkD,EAAE,IAA0B;QACxF,KAAK,CAAC,aAAa,EAAE,IAAI,EAAE,wBAAwB,CAAC,CAAC;QACrD,IAAI,CAAC,cAAc,GAAG,aAAa,CAAC,cAAc,CAAC;QACnD,IAAI,CAAC,qBAAqB,GAAG,aAAa,CAAC,qBAAqB,CAAC;QACjE,IAAI,CAAC,cAAc,GAAG,aAAa,CAAC,cAAc,CAAC;QACnD,IAAI,CAAC,eAAe,GAAG,aAAa,CAAC,eAAe,CAAC;QACrD,IAAI,CAAC,kBAAkB,GAAG,aAAa,CAAC,kBAAkB,CAAC;QAC3D,IAAI,CAAC,mBAAmB,GAAG,CAAC,CAAC;QAC7B,IAAI,CAAC,SAAS,GAAG,CAAC,CAAC;IACrB,CAAC;IAED,uBAAuB;QACrB,IAAI,IAAI,CAAC,WAAW,CAAC,2BAA2B,CAAC,MAAM,GAAG,IAAI,CAAC,qBAAqB,EAAE;YACpF,OAAO,CAAC,CAAC;SACV;QACD,MAAM,iBAAiB,GAAG,IAAI,CAAC,qBAAqB,CAAC;QAErD,MAAM,oBAAoB,GAAG,iBAAiB,GAAG,IAAI,CAAC,eAAe,CAAC;QACtE,IAAI,oBAAoB,GAAG,CAAC,CAAC;QAC7B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,iBAAiB,EAAE,CAAC,EAAE,EAAE;YAC1C,oBAAoB,IAAI,IAAI,CAAC,WAAW,CAAC,2BAA2B,CAAC,CAAC,CAAC,CAAC;SACzE;QACD,OAAO,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,oBAAoB,GAAG,oBAAoB,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;IACnF,CAAC;IAED,MAAM;QACJ,MAAM,cAAc,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,cAAc,CAAC;QACnF,IAAI,cAAc,EAAE;YAClB,OAAO,IAAI,CAAC,aAAa,CAAC;SAC3B;QACD,MAAM,oBAAoB,GAAG,IAAI,CAAC,uBAAuB,EAAE,IAAI,IAAI,CAAC,cAAc,CAAC;QACnF,IAAI,oBAAoB,EAAE;YACxB,IAAI,IAAI,CAAC,aAAa,KAAK,CAAC,EAAE;gBAC5B,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBACtC,IAAI,CAAC,SAAS,EAAE,CAAC;gBACjB,IAAI,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,kBAAkB,EAAE;oBAC5C,OAAO,CAAC,CAAC;iBACV;aACF;YACD,OAAO,CAAC,CAAC;SACV;QACD,OAAO,CAAC,CAAC;IACX,CAAC;CACF;AAtDD,6DAsDC","sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nimport BaseConnectionHealthPolicy from './BaseConnectionHealthPolicy';\nimport ConnectionHealthData from './ConnectionHealthData';\nimport ConnectionHealthPolicy from './ConnectionHealthPolicy';\nimport ConnectionHealthPolicyConfiguration from './ConnectionHealthPolicyConfiguration';\n\nexport default class UnusableAudioWarningConnectionHealthPolicy\n  extends BaseConnectionHealthPolicy\n  implements ConnectionHealthPolicy {\n  private coolDownTimeMs: number;\n  private pastSamplesToConsider: number;\n  private fractionalLoss: number;\n  private packetsExpected: number;\n  private maximumTimesToWarn: number;\n  private warnCount: number;\n  private lastWarnTimestampMs: number;\n\n  constructor(configuration: ConnectionHealthPolicyConfiguration, data: ConnectionHealthData) {\n    super(configuration, data, 'Unusable Audio Warning');\n    this.coolDownTimeMs = configuration.cooldownTimeMs;\n    this.pastSamplesToConsider = configuration.pastSamplesToConsider;\n    this.fractionalLoss = configuration.fractionalLoss;\n    this.packetsExpected = configuration.packetsExpected;\n    this.maximumTimesToWarn = configuration.maximumTimesToWarn;\n    this.lastWarnTimestampMs = 0;\n    this.warnCount = 0;\n  }\n\n  calculateFractionalLoss(): number {\n    if (this.currentData.packetsReceivedInLastMinute.length < this.pastSamplesToConsider) {\n      return 0;\n    }\n    const samplesToConsider = this.pastSamplesToConsider;\n\n    const totalPacketsExpected = samplesToConsider * this.packetsExpected;\n    let totalPacketsReceived = 0;\n    for (let i = 0; i < samplesToConsider; i++) {\n      totalPacketsReceived += this.currentData.packetsReceivedInLastMinute[i];\n    }\n    return Math.min(Math.max(1 - totalPacketsReceived / totalPacketsExpected, 0), 1);\n  }\n\n  health(): number {\n    const warnedRecently = Date.now() - this.lastWarnTimestampMs < this.coolDownTimeMs;\n    if (warnedRecently) {\n      return this.currentHealth;\n    }\n    const hasHadHighPacketLoss = this.calculateFractionalLoss() >= this.fractionalLoss;\n    if (hasHadHighPacketLoss) {\n      if (this.currentHealth !== 0) {\n        this.lastWarnTimestampMs = Date.now();\n        this.warnCount++;\n        if (this.warnCount > this.maximumTimesToWarn) {\n          return 1;\n        }\n      }\n      return 0;\n    }\n    return 1;\n  }\n}\n"]}