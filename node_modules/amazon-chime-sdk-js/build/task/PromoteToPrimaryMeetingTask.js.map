{"version":3,"file":"PromoteToPrimaryMeetingTask.js","sourceRoot":"","sources":["../../src/task/PromoteToPrimaryMeetingTask.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nimport { MeetingSessionCredentials, MeetingSessionStatus, MeetingSessionStatusCode } from '..';\nimport AudioVideoControllerState from '../audiovideocontroller/AudioVideoControllerState';\nimport Logger from '../logger/Logger';\nimport SignalingClient from '../signalingclient/SignalingClient';\nimport SignalingClientEvent from '../signalingclient/SignalingClientEvent';\nimport SignalingClientEventType from '../signalingclient/SignalingClientEventType';\nimport SignalingClientObserver from '../signalingclientobserver/SignalingClientObserver';\nimport { SdkSignalFrame } from '../signalingprotocol/SignalingProtocol.js';\nimport TaskCanceler from '../taskcanceler/TaskCanceler';\nimport BaseTask from './BaseTask';\n\n/**\n * [[PromoteToPrimaryMeetingTask]] sends a `SdkSignalFrame.PrimaryMeetingJoin` and waits for\n * a `SdkSignalFrame.PrimaryMeetingJoinAck`  frame.\n */\nexport default class PromoteToPrimaryMeetingTask extends BaseTask {\n  protected taskName = 'PromoteToPrimaryMeetingTask';\n  private taskCanceler: TaskCanceler | null = null;\n\n  constructor(\n    private context: AudioVideoControllerState,\n    private credentials: MeetingSessionCredentials,\n    private completionCallback: (status: MeetingSessionStatus) => void\n  ) {\n    super(context.logger);\n  }\n\n  cancel(): void {\n    if (this.taskCanceler) {\n      this.taskCanceler.cancel();\n      this.taskCanceler = null;\n    }\n  }\n\n  async run(): Promise<void> {\n    if (this.context.signalingClient.ready()) {\n      this.context.signalingClient.promoteToPrimaryMeeting(this.credentials);\n      this.context.logger.info('Sent request to join primary meeting');\n      await this.receivePrimaryMeetingJoinAck();\n    } else {\n      this.completionCallback(\n        new MeetingSessionStatus(MeetingSessionStatusCode.SignalingRequestFailed)\n      );\n    }\n  }\n\n  private receivePrimaryMeetingJoinAck(): Promise<void> {\n    return new Promise((resolve, _) => {\n      class Interceptor implements SignalingClientObserver, TaskCanceler {\n        constructor(\n          private signalingClient: SignalingClient,\n          private completionCallback: (status: MeetingSessionStatus) => void,\n          private logger: Logger\n        ) {}\n\n        cancel(): void {\n          this.signalingClient.removeObserver(this);\n          // Currently only cancel would come from timeout.  Should\n          // be rare enough (ignoring bugs) that we don't need to bother\n          // retrying.\n          this.completionCallback(\n            new MeetingSessionStatus(MeetingSessionStatusCode.SignalingRequestFailed)\n          );\n          resolve();\n        }\n\n        handleSignalingClientEvent(event: SignalingClientEvent): void {\n          if (event.isConnectionTerminated()) {\n            this.signalingClient.removeObserver(this);\n            this.logger.info('PromoteToPrimaryMeetingTask connection terminated');\n            // This would happen either in happy or unhappy disconnections.  The\n            // timing here is rare enough (ignoring bugs) that we don't need to bother\n            // retrying the unhappy case.\n            this.completionCallback(\n              new MeetingSessionStatus(MeetingSessionStatusCode.SignalingRequestFailed)\n            );\n            resolve();\n          }\n\n          if (\n            event.type === SignalingClientEventType.ReceivedSignalFrame &&\n            event.message.type === SdkSignalFrame.Type.PRIMARY_MEETING_JOIN_ACK\n          ) {\n            this.signalingClient.removeObserver(this);\n            this.logger.info('Got a primary meeting join ACK');\n            this.completionCallback(MeetingSessionStatus.fromSignalFrame(event.message));\n            resolve();\n          }\n        }\n      }\n\n      const interceptor = new Interceptor(\n        this.context.signalingClient,\n        this.completionCallback,\n        this.context.logger\n      );\n      this.taskCanceler = interceptor;\n      this.context.signalingClient.registerObserver(interceptor);\n    });\n  }\n}\n"]}