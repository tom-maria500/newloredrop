{"version":3,"file":"DefaultSigV4.js","sourceRoot":"","sources":["../../src/sigv4/DefaultSigV4.ts"],"names":[],"mappings":";AAAA,qEAAqE;AACrE,sCAAsC;;;;;;;;;;;;;;AAEtC,qDAA+C;AAC/C,kEAAmD;AAEnD,0EAAkD;AAGlD,MAAqB,YAAY;IAC/B,iHAAiH;IACjH,YAAmB,WAAgB;QAAhB,gBAAW,GAAX,WAAW,CAAK;IAAG,CAAC;IAE/B,aAAa,CAAC,CAAS;QAC7B,wBAAwB;QACxB,0BAA0B;QAC1B,IAAI,CAAC,GAAG,CAAC,EAAE;YACT,OAAO,CAAC,CAAC,QAAQ,EAAE,CAAC;SACrB;aAAM;YACL,OAAO,GAAG,GAAG,CAAC,CAAC,QAAQ,EAAE,CAAC;SAC3B;IACH,CAAC;IAEO,IAAI,CAAC,IAAyB,EAAE,MAA4B;QAClE,MAAM,IAAI,GAAG,IAAI,kBAAM,CAAC,MAAM,CAAC,CAAC;QAChC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAClB,OAAO,IAAI,CAAC,MAAM,EAAE,CAAC;IACvB,CAAC;IAEO,iBAAiB;QACvB,MAAM,CAAC,GAAG,IAAI,IAAI,EAAE,CAAC;QAErB,OAAO,CACL,CAAC,CAAC,cAAc,EAAE;YAClB,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,WAAW,EAAE,GAAG,CAAC,CAAC;YACvC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,UAAU,EAAE,CAAC;YAClC,GAAG;YACH,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,WAAW,EAAE,CAAC;YACnC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,aAAa,EAAE,CAAC;YACrC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,aAAa,EAAE,CAAC;YACrC,GAAG,CACJ,CAAC;IACJ,CAAC;IAEO,aAAa,CAAC,cAAsB;QAC1C,OAAO,cAAc,CAAC,SAAS,CAAC,CAAC,EAAE,cAAc,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC;IAClE,CAAC;IAEa,eAAe,CAC3B,GAAW,EACX,IAAY,EACZ,UAAkB,EAClB,WAAmB;;YAEnB,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,MAAM,GAAG,GAAG,CAAC,CAAC;YAClD,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,KAAK,CAAC,CAAC;YACnD,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,OAAO,CAAC,CAAC;YACvD,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE,QAAQ,CAAC,CAAC;YAC3D,OAAO,QAAQ,CAAC;QAClB,CAAC;KAAA;IAEK,OAAO,CACX,MAAc,EACd,MAAc,EACd,WAAmB,EACnB,QAAgB,EAChB,IAAY,EACZ,OAAe,EACf,WAAyC;;YAEzC,MAAM,GAAG,GAAG,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACrC,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC;YAEtC,MAAM,SAAS,GAAG,kBAAkB,CAAC;YACrC,IAAI,MAAM,GAAG,EAAE,CAAC;YAChB,qCAAqC;YACrC,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,YAAY,QAAQ,EAAE;gBACtD,MAAM,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC;aACjD;iBAAM;gBACL,MAAM,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC;aACzC;YAED,MAAM,aAAa,GAAG,MAAM,CAAC;YAE7B,MAAM,gBAAgB,GAAG,OAAO,GAAG,QAAQ,CAAC,WAAW,EAAE,GAAG,IAAI,CAAC;YACjE,MAAM,eAAe,GAAG,KAAK,GAAG,GAAG,GAAG,MAAM,GAAG,GAAG,GAAG,WAAW,GAAG,GAAG,GAAG,cAAc,CAAC;YACxF,IAAI,WAAW,GAAG,SAAS,CAAC;YAC5B,0CAA0C;YAC1C,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,WAAW,YAAY,QAAQ,EAAE;gBAC3D,WAAW,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,WAAW,EAAE,CAAC;aAC3D;iBAAM;gBACL,WAAW,GAAG,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,WAAW,CAAC;aACnD;YAED,IAAI,MAAM,GAA0B,IAAI,GAAG,EAAoB,CAAC;YAChE,MAAM,CAAC,GAAG,CAAC,iBAAiB,EAAE,CAAC,SAAS,CAAC,CAAC,CAAC;YAC3C,MAAM,CAAC,GAAG,CAAC,kBAAkB,EAAE;gBAC7B,kBAAkB,CAAC,WAAW,CAAC,WAAW,GAAG,GAAG,GAAG,eAAe,CAAC;aACpE,CAAC,CAAC;YACH,MAAM,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC;YAChC,MAAM,CAAC,GAAG,CAAC,eAAe,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;YACpC,MAAM,CAAC,GAAG,CAAC,qBAAqB,EAAE,CAAC,MAAM,CAAC,CAAC,CAAC;YAC5C,IAAI,WAAW,CAAC,YAAY,EAAE;gBAC5B,MAAM,CAAC,GAAG,CAAC,sBAAsB,EAAE,CAAC,kBAAkB,CAAC,WAAW,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;aACpF;YACD,MAAM,CAAC,GAAG,CAAC,oBAAU,CAAC,cAAc,EAAE,CAAC,kBAAkB,CAAC,oBAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;YACnF,MAAM,CAAC,GAAG,CAAC,oBAAU,CAAC,iBAAiB,EAAE;gBACvC,kBAAkB,CAAC,oBAAU,CAAC,yBAAyB,CAAC;aACzD,CAAC,CAAC;YAEH,WAAW,aAAX,WAAW,uBAAX,WAAW,CAAE,OAAO,CAAC,CAAC,MAAgB,EAAE,GAAW,EAAE,EAAE;gBACrD,MAAM,UAAU,GAAG,kBAAkB,CAAC,GAAG,CAAC,CAAC;gBAC3C,MAAM,CAAC,IAAI,EAAE,CAAC,OAAO,CAAC,CAAC,KAAa,EAAE,EAAE;oBACtC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE;wBAC3B,MAAM,CAAC,GAAG,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;qBAC5B;oBACD,MAAM,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC,CAAC,CAAC;gBACzD,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;YAEH,IAAI,oBAAoB,GAAG,EAAE,CAAC;YAC9B,MAAM,GAAG,IAAI,GAAG,CAAC,CAAC,GAAG,MAAM,CAAC,OAAO,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC;YAC/C,MAAM,CAAC,OAAO,CAAC,CAAC,MAAgB,EAAE,GAAW,EAAE,EAAE;gBAC/C,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;oBACrB,IAAI,oBAAoB,CAAC,MAAM,EAAE;wBAC/B,oBAAoB,IAAI,GAAG,CAAC;qBAC7B;oBACD,oBAAoB,IAAI,GAAG,GAAG,GAAG,GAAG,KAAK,CAAC;gBAC5C,CAAC,CAAC,CAAC;YACL,CAAC,CAAC,CAAC;YAEH,MAAM,gBAAgB,GACpB,MAAM;gBACN,IAAI;gBACJ,IAAI;gBACJ,IAAI;gBACJ,oBAAoB;gBACpB,IAAI;gBACJ,gBAAgB;gBAChB,IAAI;gBACJ,aAAa;gBACb,IAAI;gBACJ,yBAAK,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;YAElC,MAAM,sBAAsB,GAAG,yBAAK,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC;YAExE,MAAM,YAAY,GAChB,oBAAoB;gBACpB,GAAG;gBACH,IAAI;gBACJ,KAAK;gBACL,GAAG;gBACH,MAAM;gBACN,GAAG;gBACH,WAAW;gBACX,iBAAiB;gBACjB,sBAAsB,CAAC;YAEzB,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,eAAe,CAC3C,WAAW,CAAC,eAAe,EAC3B,KAAK,EACL,MAAM,EACN,WAAW,CACZ,CAAC;YAEF,MAAM,SAAS,GAAG,yBAAK,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,UAAU,CAAC,CAAC,CAAC;YAEnE,MAAM,WAAW,GAAG,oBAAoB,GAAG,mBAAmB,GAAG,SAAS,CAAC;YAE3E,OAAO,MAAM,GAAG,KAAK,GAAG,QAAQ,GAAG,IAAI,GAAG,GAAG,GAAG,WAAW,CAAC;QAC9D,CAAC;KAAA;CACF;AAlKD,+BAkKC","sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nimport { Sha256 } from '@aws-crypto/sha256-js';\nimport { toHex } from '@aws-sdk/util-hex-encoding';\n\nimport Versioning from '../versioning/Versioning';\nimport SigV4 from './SigV4';\n\nexport default class DefaultSigV4 implements SigV4 {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/explicit-module-boundary-types\n  constructor(public chimeClient: any) {}\n\n  private makeTwoDigits(n: number): string {\n    /* istanbul ignore if */\n    /* istanbul ignore else */\n    if (n > 9) {\n      return n.toString();\n    } else {\n      return '0' + n.toString();\n    }\n  }\n\n  private hmac(data: string | Uint8Array, secret?: string | Uint8Array): Promise<Uint8Array> {\n    const hash = new Sha256(secret);\n    hash.update(data);\n    return hash.digest();\n  }\n\n  private getDateTimeString(): string {\n    const d = new Date();\n\n    return (\n      d.getUTCFullYear() +\n      this.makeTwoDigits(d.getUTCMonth() + 1) +\n      this.makeTwoDigits(d.getUTCDate()) +\n      'T' +\n      this.makeTwoDigits(d.getUTCHours()) +\n      this.makeTwoDigits(d.getUTCMinutes()) +\n      this.makeTwoDigits(d.getUTCSeconds()) +\n      'Z'\n    );\n  }\n\n  private getDateString(dateTimeString: string): string {\n    return dateTimeString.substring(0, dateTimeString.indexOf('T'));\n  }\n\n  private async getSignatureKey(\n    key: string,\n    date: string,\n    regionName: string,\n    serviceName: string\n  ): Promise<Uint8Array> {\n    const kDate = await this.hmac(date, 'AWS4' + key);\n    const kRegion = await this.hmac(regionName, kDate);\n    const kService = await this.hmac(serviceName, kRegion);\n    const kSigning = await this.hmac('aws4_request', kService);\n    return kSigning;\n  }\n\n  async signURL(\n    method: string,\n    scheme: string,\n    serviceName: string,\n    hostname: string,\n    path: string,\n    payload: string,\n    queryParams: Map<string, string[]> | null\n  ): Promise<string> {\n    const now = this.getDateTimeString();\n    const today = this.getDateString(now);\n\n    const algorithm = 'AWS4-HMAC-SHA256';\n    let region = '';\n    // in AWS SDK v3 region is a function\n    if (this.chimeClient.config.region instanceof Function) {\n      region = await this.chimeClient.config.region();\n    } else {\n      region = this.chimeClient.config.region;\n    }\n\n    const signedHeaders = 'host';\n\n    const canonicalHeaders = 'host:' + hostname.toLowerCase() + '\\n';\n    const credentialScope = today + '/' + region + '/' + serviceName + '/' + 'aws4_request';\n    let credentials = undefined;\n    // in AWS SDK v3 credentials is a function\n    if (this.chimeClient.config.credentials instanceof Function) {\n      credentials = await this.chimeClient.config.credentials();\n    } else {\n      credentials = this.chimeClient.config.credentials;\n    }\n\n    let params: Map<string, string[]> = new Map<string, string[]>();\n    params.set('X-Amz-Algorithm', [algorithm]);\n    params.set('X-Amz-Credential', [\n      encodeURIComponent(credentials.accessKeyId + '/' + credentialScope),\n    ]);\n    params.set('X-Amz-Date', [now]);\n    params.set('X-Amz-Expires', ['10']);\n    params.set('X-Amz-SignedHeaders', ['host']);\n    if (credentials.sessionToken) {\n      params.set('X-Amz-Security-Token', [encodeURIComponent(credentials.sessionToken)]);\n    }\n    params.set(Versioning.X_AMZN_VERSION, [encodeURIComponent(Versioning.sdkVersion)]);\n    params.set(Versioning.X_AMZN_USER_AGENT, [\n      encodeURIComponent(Versioning.sdkUserAgentLowResolution),\n    ]);\n\n    queryParams?.forEach((values: string[], key: string) => {\n      const encodedKey = encodeURIComponent(key);\n      values.sort().forEach((value: string) => {\n        if (!params.has(encodedKey)) {\n          params.set(encodedKey, []);\n        }\n        params.get(encodedKey).push(encodeURIComponent(value));\n      });\n    });\n\n    let canonicalQuerystring = '';\n    params = new Map([...params.entries()].sort());\n    params.forEach((values: string[], key: string) => {\n      values.forEach(value => {\n        if (canonicalQuerystring.length) {\n          canonicalQuerystring += '&';\n        }\n        canonicalQuerystring += key + '=' + value;\n      });\n    });\n\n    const canonicalRequest =\n      method +\n      '\\n' +\n      path +\n      '\\n' +\n      canonicalQuerystring +\n      '\\n' +\n      canonicalHeaders +\n      '\\n' +\n      signedHeaders +\n      '\\n' +\n      toHex(await this.hmac(payload));\n\n    const hashedCanonicalRequest = toHex(await this.hmac(canonicalRequest));\n\n    const stringToSign =\n      'AWS4-HMAC-SHA256\\n' +\n      now +\n      '\\n' +\n      today +\n      '/' +\n      region +\n      '/' +\n      serviceName +\n      '/aws4_request\\n' +\n      hashedCanonicalRequest;\n\n    const signingKey = await this.getSignatureKey(\n      credentials.secretAccessKey,\n      today,\n      region,\n      serviceName\n    );\n\n    const signature = toHex(await this.hmac(stringToSign, signingKey));\n\n    const finalParams = canonicalQuerystring + '&X-Amz-Signature=' + signature;\n\n    return scheme + '://' + hostname + path + '?' + finalParams;\n  }\n}\n"]}